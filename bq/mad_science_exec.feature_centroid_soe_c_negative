"select\n  segmentName,\n  mappedEvent,\n  geo_iso,\n  feature_type,\n  feature,\n  feature_value\nfrom (\nSELECT\n  segmentName,\n  \"\" mappedEvent,\n  \"\" AS geo_iso,\n  \"soe_c\" AS feature_type,\n  categories.text AS feature,\n  RATIO_TO_REPORT(count) OVER (PARTITION BY segmentName, mappedEvent, geo_iso, feature_type) as feature_value,\n  count(*) as count\nFROM\n  FLATTEN((\n    SELECT\n      stid,\n      mappedEvent,\n      geo.ISO,\n      categories.text\n    FROM\n      table_date_range(mad_science_exec.mergelog_view_, \n                       date_add(current_timestamp(), -2, 'DAY'), \n                       date_add(current_timestamp(), -1, 'DAY')) \n      where float(categories.score) > 0.4), categories) ml\njoin each (select * from table_date_range(mad_science_exec.truth_data_,  \n                       date_add(current_timestamp(), -2, 'DAY'), \n                       date_add(current_timestamp(), -1, 'DAY')) where not label) mappings\non mappings.stid = ml.stid\ngroup each by\nsegmentName,\nmappedEvent,\ngeo_iso,\nfeature_type,\nfeature\n)"
