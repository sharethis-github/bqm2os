"select domain, luxury_kw_count/domain_kw_count score from (\nselect\ndomain, \ncount(distinct case when keywords.text contains 'luxur' then keywords.text else null end) luxury_kw_count,\ncount(distinct keywords.text) domain_kw_count \nfrom flatten([dataset_prod_hourly.mergelog_mini_hour_00_20170113], keywords) \nwhere float(keywords.score) > 0.4 and float(categories.score) > 0.4 and keywords.text is not null and categories.text is not null\n//and keywords.text contains 'luxur'\ngroup each by domain\n)\norder by score desc\n\n\n-- select domain, float(auto_count)/float(total_count) as p, auto_count, total_count from\n-- (\n--   select domain, count(distinct url) as total_count,\n--   count(distinct case when categories.text like \"/autos_&_vehicles%\" then url else null end) as auto_count\n--   from [mergelog.v1_20161228]\n--   where float(categories.score) > 0.8\n--   group by domain\n-- )\n-- where total_count > 1000"
