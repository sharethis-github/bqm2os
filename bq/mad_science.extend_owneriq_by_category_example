"select segment, count(*) from (\nselect oiq_id, segment from flatten([dataset_prod_hourly.mergelog_mini_hour_00_20170121], categories) mlo\njoin each (\nselect segment, categories.text, catCount, rn from (\nselect segment, categories.text, count(*) catCount, row_number() over (partition by segment order by catCount desc) rn\nfrom (\nselect segment, ml.oiq_id, categories.text, count(*) c from flatten([dataset_prod_hourly.mergelog_mini_hour_00_20170121], categories) ml\njoin each (\nSELECT segment, oiq_id FROM [owneriq_segments_prod_view_of_views.segments0_20170119] \n) s\non ml.oiq_id = s.oiq_id \nwhere categories.text is not null\nand ml.oiq_id is not null\ngroup each by segment, ml.oiq_id, categories.text\n)\ngroup each by segment, categories.text\n)\nwhere rn <= 5\n) top5\non mlo.categories.text = top5.categories.text\nwhere oiq_id is not null\ngroup each by oiq_id, segment\n)\ngroup each by segment\n"
